/****

                                ,.,*@++##*%+,.
                          ,,,+*@@@@@@@@@@@@@@@#*+.
                        +*@@@@@@@@@@@@@@@@@@@@@@@@#%,
                     ,*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#+
                   +#@@@@@@@@@@@@@@@@@@##@@@@@@@@@@@@@@@@*,
                 +#@@@@@@@@@@@#%+*#*%+,,%**@@@@#@@@@@@@@@@@@%.
              .%@@@@@@@@@@@#*+%,+,,,+.,+@.,,+*#.%*##@@@@@@@@@@%.
             %@@@@@@@@@#**%+,+#.+,,++,++*,++.+++%++,,%*@@@@@@@@@%
            +@@@@@@@@#++++++++%,,++++++%,+++++++,.%++. ,%#@@@@@@@#
           ,@@@@@@@++,,+++,++%,,++%+%%%%%,,+,.,,, .       ,@@@@@@@#
          %@@@@@@@+ .+++++%+%,*, +,+ .,%+,+,,,,+.          .@@@@@@@#.
        ,@@@@@@@@.   ,%%%%%%%,.% ,+.    ,, + .              .@@@@@@@@,
       +@@@@@@@@,      ,,  .,+ ,.        +,+                 %@@@@@@@@
      +@@@@@@@@%                          .,                 ,@@@@@@@@*
     ,@@@@@@@@*                                              .@@@@@@@@@#
     @@@@@@@@@.                                               *@@@@@@@@@#
     @@@@@@@@,                                                .@@@@@@@@@@#
    #@@@@@@@@                                                  +@@@@@@@@@@%
   %@@@@@@@@*                                                  .@@@@@@@@@@%
   +@@@@@@@@%                                                   *@@@@@@@@@*
   .@@@@@@@@%                                                    %@@@@@@@@@
    #@@@@@@@#                                                     ,@@@@@@@@.
    #@@@@@@@@,                                                    .@@@@@@@#
    *@@@@@@@@+                                                   .@@@@@@@@#
    **%@@@@@@*                                                   %@@@@@@@@@.
   ,#+*@@#@##@,                                                 .@@@@@@@@@@*
   #+,,#*+%+#@                                                  *@@@@@@@@@@#
 ,,%*%,+++++#+                                                  @@@@@@@@@@@#**+
+.   +#++++%,                                                   #@@@@@@@@@@@@@@%
+%@+  ,@%+%+                                                     %@@@@@@@@@@@@@@
+*@%*  +@%+.    .,,.                                  ..,++%**#+,.+@@@@@@@@@@@@#
+%+ +*  @@,    +@@#@@@#+.++..         .           .+%%**##@@@@@@@@#@@@@@@@@@@@@*
++,  ..+@@#   .#+   ,*#*+%%%%%+,.    +,       .+*#*%++++++,,+*@@@@@@@@%+@@@@@@@+
,+,,%,.+*@#%       ,,,,,,,%*%%%*%**+*%       *@@*,+*#*#@###*%,,#@@@@@# +@@@@@@@.
,,,@@@@%*% %+     +%*@@+%@+#@#.%#%*@%       +@@+,#*,#**@@*+@@#%,*@@@@..@@@@@@@#
 +.@@@+ +   *,   +,#*+,  %*#*,  #*.*,     . %@%,#@%,.***% +%*#@#+*@@, @@*%@@@@*
 % %@@  +    #. ., .  .,...,..,    ,++.  ,%%@#+#@, ,,,,,.,,+#@@#,%+  *@@%+*@@@+
 ,% %@* +    +#,%+.      ....     ***,      @#++#+..   ..   ,%,  %%,+@@#+%#@@@.
  **,,@,%.     ,**,               .%*       #@,,@@*%+           ,#,  ,@#+%#@@@
  .%, +@#.      %,                 .#       #+*,*#+             ,*   .@*+%@@@#
   +   **+       #.                #,       #..#.              +#    +@*%*@@@#
   ,,   *%,      .#+             ,#,        *  .*%.          ,%%    .@@%%#@@@%
    %   ++++       %*+.       .,%%.              ,%%+,,,,,++%%.     #@#%+#@@@
    .%   +++.        ,%%%%+%%%%+.              ,@+  .,+++,,.  ,+   *@@%%%@@@,
     ,+  ,%,,,....       ...                    .#+           ,@#%#@@*%%@@@*
      .,,++,.,.....              ,.               #*        .,+,#@@@*+%@@%,
         *+,...,.. ..            %               ,@#        .%@@#@@#%+#@*
         %++,,+.. ..,            ,%,,.        ,%#@@*          +@@@@%+%@@%
         %+++%%,......             .,+%.     #@@@@@* .....   +#@@#+%+#@@,
         ,+,+++,,.....            ,.,.+*%+.,*@@@@@@@*%++%%+,%@@@@%+%*@@@.
         .,,,,%+,......     ..+,,+++%%%+,**%*+*@@#%%@##*%%++#@@@%,%+@@@@.
          ,+,+%++.....  .,++++,,++++++,,,+,,%,%@@%%+%%%*@@@*#@@#,++*@@@@
          .+++%+,+,.,. ,++++,,..+,,,+.,.++,,+.,%++,%%%%#@*@@@#%%+,+@@@@%
           .+,+++,,,+,.%+,,,.+%%++,,+,+++%%%*%%++%*#@@@@%,++%+,,%,*@@@@.
            .+,++,+,+,,++,%%*@####*%*****#**#@@@@@@@@#,,%%+++%+,+%@@@@*
             ,+,,,+++,+,+%%@@.                +*+. ,+,,.,%*%%%%+,#@@@%
              ,,,,++,,,+,%@@%....                 .+,,,*%+#@@##%*@@@*
               ++++,,,+,+*@#+++++++++, ,+,,+++%,%++,++%,++%@@@@@@@@@
                ,%+,.,++++,..+++++++##*@@@#@@@@#+%,%+%+,+++@@@@@@@@,
                 .,+++,++,++%++%+..,+%%%%%++%+***+,+%+%%+++#@@@@@@,
                  .+,+++%%++%,,,,     .+ ,+,.+,  .+++++%%++#@@@@@,
                    ,+,++,,+,,,,+,.             .++%++++%*#@@@@@,
                     .%+,,,,+++++%,  .    .++ +,+%+,++++#@@@@@#.
                      ..,+,,,,++++,+%,,++,,+++++++++,+,*@@@@@%
                        ,,,,,+,++,+++.+++++,,,+++,+.+,%@@@@#,
                          ,,%,,,.+++.,++,++%*%,,++.,,*@@@#,
                           .%##+,,,,.+,,,%#@@@*++%+#@@#%.
                              +%%%,,,++%*@@@@@@@@@@#%.
                                   .,+%%%*@##*%%,.
*/
package main

import (
	"bytes"
	"flag"
	"fmt"
	"github.com/nfnt/resize"
	"image/png"
	"os"
)

func main() {

	imgArg := flag.String("img", "./avatar.png", "png image path")
	size := flag.Uint("size", 100, "size")
	pixel := flag.Uint("pixel", 2, "if type=html ,pixel of cell")
	margin := flag.Uint("margin", 1, "pixel margin")
	output := flag.String("output", "outputfile", "output file")
	t := flag.String("type", "text", "text or html")

	flag.Parse()

	if *t == "text" {
		img2txt(*imgArg, *size, []string{"@", "#", "*", "%", "+", ",", ".", " "}, "\n", *output)
	} else {
		img2html(*imgArg, *size, *pixel, *margin, *output)
	}

}

func img2txt(imgPath string, size uint, txts []string, rowend string, output string) {
	file, err := os.Open(imgPath)
	if err != nil {
		fmt.Println(err.Error())
		return
	}
	defer file.Close()

	img, err := png.Decode(file)
	if err != nil {
		fmt.Println(err.Error())
		return
	}

	var width = size
	var height = (size * uint(img.Bounds().Dy())) / (uint(img.Bounds().Dx()))
	height = height * 6 / 10
	newimg := resize.Resize(width, height, img, resize.Lanczos3)
	dx := newimg.Bounds().Dx()
	dy := newimg.Bounds().Dy()

	textBuffer := bytes.Buffer{}

	for y := 0; y < dy; y++ {
		for x := 0; x < dx; x++ {
			colorRgb := newimg.At(x, y)
			r, g, b, _ := colorRgb.RGBA()
			avg := uint8((r + g + b) / 3 >> 8)
			num := avg / uint8(256/len(txts))

			textBuffer.WriteString(txts[num])
			fmt.Print(txts[num])
		}

		textBuffer.WriteString(rowend)
		fmt.Print(rowend)
	}

	f, err := os.Create(output + ".txt")
	if err != nil {
		fmt.Println(err.Error())
		return
	}
	defer f.Close()

	f.WriteString(textBuffer.String())
}

func img2html(imgPath string, size uint, pixel uint, margin uint, output string) {
	file, err := os.Open(imgPath)
	if err != nil {
		fmt.Println(err.Error())
		return
	}
	defer file.Close()

	img, err := png.Decode(file)
	if err != nil {
		fmt.Println(err.Error())
		return
	}

	var width = size
	var height = (size * uint(img.Bounds().Dy())) / (uint(img.Bounds().Dx()))

	newimg := resize.Resize(width, height, img, resize.Lanczos3)

	dx := newimg.Bounds().Dx()
	dy := newimg.Bounds().Dy()

	htmlBuffer := bytes.Buffer{}
	htmlBuffer.WriteString(fmt.Sprintf(`<html>
	<style>
	.cell{
		width:%dpx;
		height:%dpx;
		float:left;
		margin:%dpx;
	}
	</style>
	<body>`, pixel, pixel, margin))

	for y := 0; y < dy; y++ {
		for x := 0; x < dx; x++ {
			colorRgb := newimg.At(x, y)
			r, g, b, _ := colorRgb.RGBA()
			colorString := fmt.Sprintf("rgb(%d,%d,%d)", r>>8, g>>8, b>>8)
			cell := fmt.Sprintf("<div class='cell' style='background-Color:%s'></div>", colorString)
			htmlBuffer.WriteString(cell)
		}

		htmlBuffer.WriteString("<div style='clear:both'></div>")
	}

	htmlBuffer.WriteString("</body><html>")

	f, err := os.Create(output + ".html")
	if err != nil {
		fmt.Println(err.Error())
		return
	}
	defer f.Close()

	_, err = f.WriteString(htmlBuffer.String())
	if err != nil {
		fmt.Println(err.Error())
		return
	}

}

/*

                                         .......
                                   ..,,++++++++++++++,..
                               .,++++,,,,,,,,,,,,,,,,,++++,.
                             ,+++,,,,,,,,,,,,,,,,,,,,,,,,,+++,.
                          .+++,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,+++.
                  ..... .++,.,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,++.
                .+++,,+++,.,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,+++,,++++,.
                %,.,,,,,.,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,..,,,,,,,,%,
                %.,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,%
                ,%,,,,,,,,,,,,,..       .,,,,,,,,,,,..       ..,,,,,,,,,,,,.++
                 .++,,,,,,,,,.            .,,,,,,,,.            ,,,,,,,,..,++
                   %,,,,,,,,               .,,,,,,               .,,,,,.,++.
                   %.,,,,,,.                ,,,,,.                .,,,.++
                  .%.,,,,,.      .+%%,      .,..,.       ,+,       ,,,.+,
                  .%.,,,,,.     ,, %@@*     .,..,.     ,,,*@#,     ,,,.+,
                  .%.,,,,,,     %#%#@@@     ....,.     #%.*@@#    .,,,.%.
                   %.,,...,.     #@@@@+     ,.....     ,@@@@@+    .,,,.%.
                   %,......,      .,.      ......,.     .+%+.    .,,,,,%
                   %.........            ....,,,..,.            .,,,,.,%
                   %...........        ..,.,*#@@#+.,,..        .,...,.,%
                  .%.......................*@@@@@@,..........,,,......,%
                  .+........................+%**+,....................,%
                  ,+.........................    .....................,%
                  ++.......................      .....................,%
                  +,........................     ......................%
                  %,...................................................%
                  %....................................................%.
                  %....................................................%.
                 .%....................................................%.
                ,+,....................................................+,
               ++......................................................+++,
               % .........................................................++
               %...........................................................%
               .,++....................................................++,+,
                 ,+..................................................,.+,
                 .+..................................................,.+.
                 .%..................................................,.%.
                  %.................................................,,.%
                  +,................................................,.,%
                  .%.,..............................................,.+,
                   %,..............................................,,.%.
                   .%.,............................................,.++
                    ,+.,..........................................,,,%
                     ++..,.......................................,..%.
                      ,%,.......................................,.,%.
                       .++,,,.................................,,,++.
                         %%.,,,.........,...................,,,,,%,
                        %,....,+,,..+**%,.................,,+,....++
                        .++,,,+,,++%@@@@,,,,....,,,,,,,++++,,+,,,++.
                                  ,@@@@#,,+++++++++,,,,..
                                  *@@@@,
               ..                ,@@@@,           ..     ,%+.  .,,               ..
       ,%#@@#*#@@*    .%#@#*%,   #@@@,    .+*#@@#*@@@,  ,@@@%,#@@@@,     ,%#@@#*#@@*
     ,*@@@@##@@@@+   %@@@#@@@@+ ,@@@*    %@@@@@#@@@@#   *@@#*@@@@@@+   ,#@@@@##@@@@,
    +@@@@%. %@@@*   #@@@* +@@@% *@@@,   *@@@#, .#@@@.  ,@@@@@%,@@@#   +@@@@%. %@@@*
   ,@@@@,  %@@@@.  %@@@*  .@@@,.@@@*   *@@@*  .#@@@+   %@@@@+ #@@@,  +@@@@,  %@@@@.
   *@@@,  *@@@@+   #@@@.  %@@# +@@@,  .@@@#  ,@@@@*   .@@@@+ %@@@*   #@@@,  *@@@@+
   #@@@.,#@@@@*  .%@@@*  %@@#. *@@#   %@@@*.%@@@@@,  ,*@@@% .@@@@.  +@@@#.+@@@@@*  .%@,
   %@@@@@##@@@##@@@#@@@#@@@*.  +@@@@@@@@@@@@@*+@@@@@@@@@@*   #@@@@@@@@@@@@@##@@@##@@@*.
    +%*%,+@@@#*%%+. .%***+.     .+%*%+,.+**%,  .+%%%%,+*%     ,%%*%+, +%%+,%@@@#*%%+.
       ,#@@@*                                                            ,#@@@%
      *@@@@*                                                            *@@@@*
     ,@@@@*                                                            ,@@@@%
      ,%+.                                                              ,%+.
*/
